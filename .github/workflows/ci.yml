name: Damago iOS CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build:
    runs-on: macos-26
    timeout-minutes: 30 # 빌드가 30분을 넘어가면 강제 종료
    
    steps:
    - uses: actions/checkout@v4

    # Ruby 환경 설정
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true

    # Xcode 버전 선택
    - name: Select Xcode 26.1
      run: sudo xcode-select -s /Applications/Xcode_26.1.app/Contents/Developer

    # GoogleService-Info.plist 생성
    - name: Create GoogleService-Info.plist
      run: |
        mkdir -p ./Damago/Damago/Resources
        
        # Dev 파일은 빌드 검증(Debug)을 위해 항상 생성
        echo "${{ secrets.GOOGLE_SERVICE_INFO_PLIST_DEV_BASE64 }}" | base64 --decode > ./Damago/Damago/Resources/GoogleService-Info-Dev.plist
        
        # Main 브랜치인 경우 Release 빌드를 위해 Prod 파일 추가 생성
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "${{ secrets.GOOGLE_SERVICE_INFO_PLIST_PROD_BASE64 }}" | base64 --decode > ./Damago/Damago/Resources/GoogleService-Info-Prod.plist
        fi

    - name: Reset Simulators
      run: |
        xcrun simctl shutdown all
        xcrun simctl erase all

    # [추가] SPM 캐시 적용 (DerivedData 및 SPM 캐시 저장/복구)
    - name: Cache Xcode DerivedData & SwiftPM
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/Library/Caches/org.swift.swiftpm
        # Package.resolved 파일이 변경될 때만 캐시를 새로 생성
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    # 패키지 해결 (캐시가 있으면 매우 빠르게 넘어감)
    - name: Resolve Package Dependencies
      run: |
        xcodebuild -resolvePackageDependencies \
          -project ./Damago/Damago.xcodeproj \
          -scheme Damago \
          -configuration Debug

    # Fastlane 실행
    - name: Run Fastlane Tests
      env:
        FASTLANE_XCODE_LIST_TIMEOUT: 120
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
      run: bundle exec fastlane test

# Merge 시에 함수 배포
  deploy-functions:
    name: Deploy Firebase Functions
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install Python Dependencies
        run: |
          cd DamagoFirebase/functions
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          cd DamagoFirebase
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            firebase deploy --only functions --project prod --force
          else
            firebase deploy --only functions --project dev --force
          fi
