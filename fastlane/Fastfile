default_platform(:ios)

platform :ios do
  desc "Run tests for Debug and Build verification for Release"
  lane :test do
    # ----------------------------------------------------------------
    # 1. ê³µí†µ íƒ€ê²Ÿ ì„¤ì •
    # ----------------------------------------------------------------
    device_name = "iPhone 17 Pro"
    os_version = "26.2"
    
    # OS ë²„ì „ê¹Œì§€ í¬í•¨ëœ ì™„ì „í•œ destination ë¬¸ìì—´
    target_destination = "platform=iOS Simulator,name=#{device_name},OS=#{os_version}"

    # ----------------------------------------------------------------
    # 2. Debug ëª¨ë“œ: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
    # ----------------------------------------------------------------
    puts "ğŸš€ Testing Debug build..."
    scan(
      project: "./Damago/Damago.xcodeproj",
      scheme: "Damago",
      configuration: "Debug",
      device: "iPhone 17 Pro (26.2)", 
      clean: false,
      xcargs: "-skipPackagePluginValidation -parallel-testing-enabled NO"
    )

    # ----------------------------------------------------------------
    # 3. Main ë¸Œëœì¹˜ì¸ ê²½ìš°: Release ëª¨ë“œ ë¹Œë“œ ê²€ì¦(Build Only)
    # ----------------------------------------------------------------
    current_branch = git_branch
    if current_branch == "main" || ENV["GITHUB_REF_NAME"] == "main"
      puts "ğŸ“¦ Building Release build (Skip Tests)..."
      
      xcodebuild(
        project: "./Damago/Damago.xcodeproj",
        scheme: "Damago",
        configuration: "Release",
        clean: false,
        build: true,      
        analyze: false,   
        destination: target_destination,
        xcargs: "-skipPackagePluginValidation RUN_CLANG_STATIC_ANALYZER=NO ARCHS=arm64"
      )
    end
  end
end