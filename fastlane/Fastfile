default_platform(:ios)

platform :ios do
  desc "Run tests for Debug and Build verification for Release"
  lane :test do
    # ----------------------------------------------------------------
    # 1. ê³µí†µ ì„¤ì • ë° ì‹œë®¬ë ˆì´í„° ì‚¬ì „ ë¶€íŒ…
    # ----------------------------------------------------------------
    device_name = "iPhone 17 Pro"
    
    # xcodebuildê°€ ì‹œë®¬ë ˆì´í„°ë¥¼ ì¼œëŠë¼ ë©ˆì¶”ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë¯¸ë¦¬ ë¶€íŒ…
    puts "ğŸ“± Booting #{device_name}..."
    sh("xcrun simctl boot '#{device_name}' || true") 
    sh("xcrun simctl bootstatus '#{device_name}'")

    # ----------------------------------------------------------------
    # 2. Debug ëª¨ë“œ: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(Test) ìˆ˜í–‰
    # ----------------------------------------------------------------
    puts "ğŸš€ Testing Debug build..."
    scan(
      project: "./Damago/Damago.xcodeproj",
      scheme: "Damago",
      configuration: "Debug",
      device: device_name,
      clean: true,
      
      # [í•µì‹¬] 30ë¶„ íƒ€ì„ì•„ì›ƒ ë°©ì§€ë¥¼ ìœ„í•´ ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ë¹„í™œì„±í™”
      xcargs: "-skipPackagePluginValidation -parallel-testing-enabled NO"
    )

    # ----------------------------------------------------------------
    # 3. Main ë¸Œëœì¹˜ì¸ ê²½ìš°: Release ëª¨ë“œ ë¹Œë“œ ê²€ì¦(Build Only)
    # ----------------------------------------------------------------
    current_branch = git_branch
    if current_branch == "main" || ENV["GITHUB_REF_NAME"] == "main"
      puts "ğŸ“¦ Building Release build (Skip Tests)..."
      
      # scan(í…ŒìŠ¤íŠ¸) ëŒ€ì‹  xcodebuild(ë¹Œë“œ)ë§Œ ì‹¤í–‰
      # Release ëª¨ë“œì—ì„œ ì»´íŒŒì¼ ì—ëŸ¬ê°€ ì—†ëŠ”ì§€ë§Œ ë¹ ë¥´ê²Œ í™•ì¸í•©ë‹ˆë‹¤.
      xcodebuild(
        project: "./Damago/Damago.xcodeproj",
        scheme: "Damago",
        configuration: "Release",
        clean: true,
        build: true,      # í…ŒìŠ¤íŠ¸ ì—†ì´ ë¹Œë“œ ì•¡ì…˜ë§Œ ìˆ˜í–‰
        analyze: false,   # ì •ì  ë¶„ì„ ìƒëµ (ì†ë„ í–¥ìƒ)
        
        # CIì— ì¸ì¦ì„œ ì„¸íŒ…ì´ ì—†ì–´ë„ ë¹Œë“œê°€ í„°ì§€ì§€ ì•Šë„ë¡ 'ì‹œë®¬ë ˆì´í„°'ìš©ìœ¼ë¡œ ë¹Œë“œ
        destination: "platform=iOS Simulator,name=#{device_name}",
        xcargs: "-skipPackagePluginValidation"
      )
    end
  end
end